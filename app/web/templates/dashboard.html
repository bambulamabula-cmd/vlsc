{% extends "base.html" %}
{% block content %}
<section class="grid gap-3 sm:grid-cols-3">
  <article class="rounded-2xl bg-white p-4 shadow-sm dark:bg-slate-900"><p class="text-xs text-slate-500">Total</p><p class="text-2xl font-bold">{{ servers|length }}</p></article>
  <article class="rounded-2xl bg-white p-4 shadow-sm dark:bg-slate-900"><p class="text-xs text-slate-500">Alive</p><p class="text-2xl font-bold text-emerald-500">{{ alive_total }}</p></article>
  <article class="rounded-2xl bg-white p-4 shadow-sm dark:bg-slate-900"><p class="text-xs text-slate-500">Xray OK</p><p class="text-2xl font-bold text-blue-500">{{ xray_total }}</p></article>
</section>

<section class="rounded-2xl bg-white p-4 shadow-sm dark:bg-slate-900">
  <div class="mb-3 flex flex-wrap gap-2 text-sm">
    <select id="aliveFilter" class="rounded border border-slate-300 bg-transparent px-2 py-1 dark:border-slate-700">
      <option value="">Alive: all</option>
      <option value="true">Alive only</option>
      <option value="false">Dead only</option>
    </select>
    <select id="xrayFilter" class="rounded border border-slate-300 bg-transparent px-2 py-1 dark:border-slate-700">
      <option value="">Xray: all</option>
      <option value="true">Xray OK</option>
      <option value="false">Xray fail</option>
    </select>
    <select id="sortFilter" class="rounded border border-slate-300 bg-transparent px-2 py-1 dark:border-slate-700">
      <option value="updated_desc">Sort: updated</option>
      <option value="score_desc">Score ↓</option>
      <option value="score_asc">Score ↑</option>
      <option value="name_asc">Name A-Z</option>
    </select>
    <input id="topN" type="number" min="1" placeholder="Top N" class="w-24 rounded border border-slate-300 bg-transparent px-2 py-1 dark:border-slate-700" />
    <button id="applyFilters" class="rounded bg-blue-600 px-3 py-1 text-white">Apply</button>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full text-left text-sm">
      <thead class="text-slate-500"><tr><th>Name</th><th>Host</th><th>Alive</th><th>Xray</th><th>Score</th></tr></thead>
      <tbody id="serverRows">
        {% for server in servers %}
        <tr class="border-t border-slate-200 dark:border-slate-800">
          <td class="py-2"><a class="text-blue-500" href="/servers/{{ server.id }}">{{ server.name }}</a></td>
          <td>{{ server.host }}:{{ server.port }}</td>
          <td>{{ "✅" if server.alive else "❌" }}</td>
          <td>{{ "✅" if server.xray_ok else "—" }}</td>
          <td>{{ server.score if server.score is not none else "—" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="rounded-2xl bg-white p-4 shadow-sm dark:bg-slate-900">
  <h2 class="mb-2 text-lg font-semibold">Import URI</h2>
  <form action="/api/import" method="post" enctype="multipart/form-data" class="grid gap-2">
    <textarea name="uris_text" rows="5" placeholder="Paste one URI per line" class="rounded border border-slate-300 bg-transparent p-2 dark:border-slate-700"></textarea>
    <input type="file" name="uris_file" accept=".txt" class="text-sm" />
    <button class="w-fit rounded bg-emerald-600 px-3 py-1 text-white">Import</button>
  </form>
</section>

<script>
  document.getElementById('applyFilters')?.addEventListener('click', async () => {
    const alive = document.getElementById('aliveFilter').value;
    const xray = document.getElementById('xrayFilter').value;
    const sort = document.getElementById('sortFilter').value;
    const top = document.getElementById('topN').value;
    const params = new URLSearchParams();
    if (alive) params.set('alive', alive);
    if (xray) params.set('xray', xray);
    if (sort) params.set('sort', sort);
    if (top) params.set('top', top);

    const response = await fetch(`/api/servers?${params.toString()}`);
    const payload = await response.json();
    const rows = document.getElementById('serverRows');
    rows.textContent = '';

    payload.items.forEach((server) => {
      const row = document.createElement('tr');
      row.className = 'border-t border-slate-200 dark:border-slate-800';

      const nameCell = document.createElement('td');
      nameCell.className = 'py-2';
      const link = document.createElement('a');
      link.className = 'text-blue-500';
      link.href = `/servers/${encodeURIComponent(String(server.id))}`;
      link.textContent = server.name ?? '';
      nameCell.appendChild(link);

      const hostCell = document.createElement('td');
      hostCell.textContent = `${server.host}:${server.port}`;

      const aliveCell = document.createElement('td');
      aliveCell.textContent = server.alive ? '✅' : '❌';

      const xrayCell = document.createElement('td');
      xrayCell.textContent = server.xray_ok ? '✅' : '—';

      const scoreCell = document.createElement('td');
      scoreCell.textContent = server.score ?? '—';

      row.append(nameCell, hostCell, aliveCell, xrayCell, scoreCell);
      rows.appendChild(row);
    });
  });
</script>
{% endblock %}
